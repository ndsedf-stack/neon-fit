<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>SESSION // HYBRID</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&family=Inter:wght@400;500;600;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    :root {
      --cyan: #22d3ee;
      --bg: #020617;
    }
    body {
        background-color: var(--bg);
        font-family: 'Inter', sans-serif;
        color: white;
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        touch-action: manipulation; /* No double-tap zoom */
    }
    
    /* Font Utils */
    .font-hud { font-family: 'Rajdhani', sans-serif; }
    .font-mono-tech { font-family: 'Share Tech Mono', monospace; }

    /* --- GLASS PANEL --- */
    .glass-panel {
        background: rgba(30, 41, 59, 0.4);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 24px;
    }

    /* --- CONTROLS --- */
    .control-btn {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 16px;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.1s;
    }
    .control-btn:active {
        background: rgba(34, 211, 238, 0.2);
        border-color: var(--cyan);
        transform: scale(0.95);
    }

    /* --- BIG BUTTON --- */
    .action-btn {
        background: linear-gradient(135deg, #0891b2 0%, #2563eb 100%);
        box-shadow: 0 0 30px rgba(8, 145, 178, 0.4);
        border-radius: 20px;
        position: relative;
        overflow: hidden;
        transition: transform 0.1s;
    }
    .action-btn:active { transform: scale(0.98); box-shadow: 0 0 15px rgba(8, 145, 178, 0.6); }

    /* --- REST OVERLAY --- */
    #rest-overlay {
        position: fixed; inset: 0; z-index: 100;
        background: #020617;
        transform: translateY(100%);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
    }
    #rest-overlay.active { transform: translateY(0); }

    /* Ring SVG */
    .progress-ring__circle {
        transition: stroke-dashoffset 1s linear;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
    }

    /* --- DOTS --- */
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #334155; transition: 0.3s; }
    .dot.active { background: white; box-shadow: 0 0 8px white; transform: scale(1.2); }
    .dot.done { background: var(--cyan); }

  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="flex-none h-16 px-5 flex justify-between items-center bg-black/20 border-b border-white/5 backdrop-blur-sm z-50">
      <button onclick="window.history.back()" class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-slate-400 active:bg-white/10">
          <i data-lucide="chevron-left" class="w-6 h-6"></i>
      </button>

      <div class="flex flex-col items-center">
           <div class="text-[9px] font-bold text-red-500 uppercase tracking-widest animate-pulse">Live Session</div>
           <div class="font-mono-tech text-lg text-white font-bold" id="timer">00:00</div>
      </div>

      <button onclick="alert('Progress Saved')" class="w-10 h-10 rounded-xl bg-cyan-500/10 border border-cyan-500/30 flex items-center justify-center text-cyan-400 active:bg-cyan-500/20">
          <i data-lucide="save" class="w-5 h-5"></i>
      </button>
  </header>

  <!-- CONTENT -->
  <main class="flex-1 flex flex-col p-4 overflow-hidden relative">
      
      <!-- EXERCISE CARD -->
      <div class="glass-panel p-6 flex-1 max-h-[45%] flex flex-col relative overflow-hidden">
           <div class="absolute top-0 right-0 p-4 opacity-10"><i data-lucide="activity" class="w-32 h-32 text-white"></i></div>
           
           <div class="relative z-10 flex-1 flex flex-col justify-center">
               <div class="flex items-center gap-2 mb-2">
                   <span class="px-1.5 py-0.5 rounded bg-white/10 text-[9px] font-bold text-slate-300 uppercase tracking-wider" id="muscle-tag">TARGET</span>
                   <div class="flex gap-1.5" id="dots-container"></div>
               </div>
               
               <h1 class="text-4xl font-hud font-black text-white leading-[0.9] uppercase italic mb-6 text-shadow-sm" id="ex-name">
                   LOADING...
               </h1>

               <div class="grid grid-cols-3 gap-2">
                   <div class="bg-black/30 rounded-lg p-3 text-center border border-white/5">
                       <div class="text-[8px] text-slate-500 uppercase font-bold mb-1">Target</div>
                       <div class="text-xl font-mono-tech font-bold text-white leading-none"><span id="t-sets">0</span>x<span id="t-reps">0</span></div>
                   </div>
                   <div class="bg-black/30 rounded-lg p-3 text-center border border-white/5">
                       <div class="text-[8px] text-slate-500 uppercase font-bold mb-1">Load</div>
                       <div class="text-xl font-mono-tech font-bold text-cyan-400 leading-none" id="t-load">0</div>
                   </div>
                   <div class="bg-black/30 rounded-lg p-3 text-center border border-white/5">
                       <div class="text-[8px] text-slate-500 uppercase font-bold mb-1">Rest</div>
                       <div class="text-xl font-mono-tech font-bold text-white leading-none" id="t-rest">90s</div>
                   </div>
               </div>
           </div>
           
           <!-- Tech Note -->
           <div class="mt-4 pt-3 border-t border-white/10">
               <div class="text-[10px] text-cyan-300 font-mono-tech uppercase tracking-tight flex items-start gap-2">
                   <i data-lucide="info" class="w-3 h-3 mt-0.5 flex-shrink-0"></i>
                   <span id="tech-note">Technique notes will appear here.</span>
               </div>
           </div>
      </div>

      <!-- INPUTS -->
      <div class="mt-4 flex-1 flex flex-col justify-end gap-3">
          
          <!-- Weight & Reps Grid -->
          <div class="grid grid-cols-2 gap-3">
              <!-- Weight -->
              <div class="bg-slate-900/50 border border-white/10 rounded-2xl p-4 flex flex-col items-center">
                  <span class="text-[9px] text-slate-500 uppercase font-bold mb-2">WEIGHT (KG)</span>
                  <div class="flex items-center justify-between w-full">
                      <button onclick="modWeight(-2.5)" class="control-btn w-10 h-10 text-2xl font-bold">-</button>
                      <span class="text-3xl font-hud font-black text-white" id="in-weight">0</span>
                      <button onclick="modWeight(2.5)" class="control-btn w-10 h-10 text-2xl font-bold">+</button>
                  </div>
              </div>

              <!-- Reps -->
              <div class="bg-slate-900/50 border border-white/10 rounded-2xl p-4 flex flex-col items-center">
                  <span class="text-[9px] text-slate-500 uppercase font-bold mb-2">REPS</span>
                  <div class="flex items-center justify-between w-full">
                      <button onclick="modReps(-1)" class="control-btn w-10 h-10 text-2xl font-bold">-</button>
                      <span class="text-3xl font-hud font-black text-white" id="in-reps">0</span>
                      <button onclick="modReps(1)" class="control-btn w-10 h-10 text-2xl font-bold">+</button>
                  </div>
              </div>
          </div>

          <!-- RPE Slider -->
          <div class="bg-slate-900/50 border border-white/10 rounded-2xl p-4">
              <div class="flex justify-between items-end mb-2">
                  <span class="text-[9px] text-slate-500 uppercase font-bold">INTENSITY (RPE)</span>
                  <span class="text-xl font-bold text-yellow-400 font-mono-tech" id="in-rpe">7</span>
              </div>
              <input type="range" min="5" max="10" step="0.5" value="7" oninput="updRPE(this.value)" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-yellow-400">
          </div>

      </div>

  </main>

  <!-- ACTION BUTTON (Fixed Bottom) -->
  <div class="p-4 bg-gradient-to-t from-black to-transparent z-40">
      <button onclick="logSet()" class="action-btn w-full h-16 flex items-center justify-center gap-3">
          <span class="text-xl font-hud font-black text-white uppercase tracking-[0.2em]">LOG SET</span>
          <i data-lucide="check" class="w-6 h-6 text-white stroke-[3]"></i>
      </button>
  </div>

  <!-- REST OVERLAY -->
  <div id="rest-overlay">
      <div class="relative w-64 h-64 mb-10">
          <svg class="progress-ring" width="256" height="256">
              <circle class="progress-ring__circle" stroke="#1e293b" stroke-width="8" fill="transparent" r="120" cx="128" cy="128"/>
              <circle id="timer-ring" class="progress-ring__circle" stroke="#22d3ee" stroke-width="8" fill="transparent" r="120" cx="128" cy="128" stroke-dasharray="753.98" stroke-dashoffset="0" stroke-linecap="round"/>
          </svg>
          <div class="absolute inset-0 flex flex-col items-center justify-center">
              <div class="text-xs font-bold text-slate-500 uppercase tracking-widest animate-pulse">RECOVER</div>
              <div class="text-6xl font-mono-tech font-bold text-white" id="rest-time">00:00</div>
          </div>
      </div>
      
      <div class="flex gap-4 w-full px-8">
          <button onclick="addRest(30)" class="flex-1 h-14 rounded-xl bg-slate-800 border border-slate-700 text-white font-bold uppercase tracking-wider hover:bg-slate-700">+30s</button>
          <button onclick="skipRest()" class="flex-1 h-14 rounded-xl bg-red-500/10 border border-red-500/30 text-red-500 font-bold uppercase tracking-wider hover:bg-red-500/20">SKIP</button>
      </div>

      <div class="mt-8 text-center opacity-60">
          <div class="text-[9px] text-slate-500 uppercase font-bold mb-1">UP NEXT</div>
          <div class="text-lg font-hud font-bold text-white uppercase" id="next-ex-name">...</div>
      </div>
  </div>

  <script type="module">
    import programData from './program-data.js';

    // STATE
    let s = { week:1, day:'dimanche', exIdx:0, setIdx:0, start: Date.now() };
    let workout = null;
    let restTimer = null;

    // --- HTML EXPOSED FUNCTIONS ---
    window.modWeight = (d) => {
        const el = document.getElementById('in-weight');
        let v = parseFloat(el.textContent) + d;
        if(v<0) v=0;
        el.textContent = v%1===0 ? v : v.toFixed(1);
    };
    window.modReps = (d) => {
        const el = document.getElementById('in-reps');
        let v = parseInt(el.textContent) + d;
        if(v<0) v=0;
        el.textContent = v;
    };
    window.updRPE = (v) => document.getElementById('in-rpe').textContent = v;

    window.logSet = () => {
        const dots = document.getElementById('dots-container').children;
        if(dots[s.setIdx]) {
            dots[s.setIdx].classList.remove('active');
            dots[s.setIdx].classList.add('done');
        }
        
        s.setIdx++;
        const ex = workout.exercises[s.exIdx];
        
        // Check if exercise done
        if(s.setIdx >= ex.sets) {
             startRest(ex.rest || 90, true);
        } else {
             if(dots[s.setIdx]) dots[s.setIdx].classList.add('active');
             startRest(ex.rest || 90, false);
        }
    };

    window.skipRest = (isExDone) => {
        clearInterval(restTimer);
        document.getElementById('rest-overlay').classList.remove('active');
        if(isExDone === true || (isExDone === undefined && window._nextEx === true)) {
            loadEx(s.exIdx + 1);
        }
    };

    window.addRest = (sec) => {
        window._remTime += sec;
        window._totalTime += sec; // Extend total base to keep ring logical
    };


    // --- LOGIC ---
    function init() {
        const p = new URLSearchParams(window.location.search);
        s.week = parseInt(p.get('week')) || 1;
        s.day = p.get('day') || 'dimanche';
        
        // Debug safe check
        try {
            workout = programData.getWorkout(s.week, s.day);
            if(!workout) throw new Error("No workout found");
        } catch(e) {
            alert("Error loading workout data. Redirecting.");
            window.location.href='workouts.html';
            return;
        }

        // Global Timer
        setInterval(()=>{
            const d = Math.floor((Date.now()-s.start)/1000);
            const m = Math.floor(d/60).toString().padStart(2,'0');
            const sc = (d%60).toString().padStart(2,'0');
            document.getElementById('timer').textContent = `${m}:${sc}`;
        }, 1000);

        loadEx(0);
        lucide.createIcons();
    }

    function loadEx(idx) {
        if(idx >= workout.exercises.length) {
            alert("MISSION COMPLETE");
            window.location.href='workouts.html';
            return;
        }
        
        s.exIdx = idx;
        s.setIdx = 0;
        const ex = workout.exercises[idx];

        // UI Updates
        document.getElementById('ex-name').textContent = ex.name;
        document.getElementById('muscle-tag').textContent = ex.muscle[0];
        document.getElementById('t-sets').textContent = ex.sets;
        document.getElementById('t-reps').textContent = ex.reps;
        document.getElementById('t-load').textContent = ex.weight + 'kg';
        document.getElementById('t-rest').textContent = (ex.rest||120)+'s';
        
        const noteEl = document.getElementById('tech-note');
        if(ex.notes) {
            noteEl.textContent = ex.notes;
            noteEl.parentElement.style.display = 'block';
        } else {
            noteEl.parentElement.style.display = 'none';
        }

        // Inputs Defaults
        document.getElementById('in-weight').textContent = ex.weight;
        const rDef = typeof ex.reps === 'string' ? parseInt(ex.reps.split('-')[1]||ex.reps) : ex.reps;
        document.getElementById('in-reps').textContent = rDef;

        // Render Dots
        const dc = document.getElementById('dots-container');
        dc.innerHTML = '';
        for(let i=0; i<ex.sets; i++) {
            const d = document.createElement('div');
            d.className = `dot ${i===0?'active':''}`;
            dc.appendChild(d);
        }
    }

    function startRest(duration, isExDone) {
        const ol = document.getElementById('rest-overlay');
        ol.classList.add('active');
        
        const nextEx = workout.exercises[s.exIdx + 1];
        document.getElementById('next-ex-name').textContent = isExDone 
            ? (nextEx ? nextEx.name : "FINISH PROTOCOL") 
            : "NEXT SET";
        
        window._nextEx = isExDone; // Store for skip btn
        window._remTime = duration;
        window._totalTime = duration;

        const ring = document.getElementById('timer-ring');
        const circumference = 753.98;
        ring.style.strokeDasharray = `${circumference} ${circumference}`;

        if(restTimer) clearInterval(restTimer);
        
        restTimer = setInterval(() => {
            window._remTime--;
            
            // Text
            const m = Math.floor(window._remTime/60).toString().padStart(2,'0');
            const sc = (window._remTime%60).toString().padStart(2,'0');
            document.getElementById('rest-time').textContent = `${m}:${sc}`;

            // Ring
            const offset = circumference - (window._remTime / window._totalTime) * circumference;
            ring.style.strokeDashoffset = offset;

            if(window._remTime <= 0) {
                if(navigator.vibrate) navigator.vibrate([200,100,200]);
                skipRest(isExDone);
            }
        }, 1000);
    }

    init();
  </script>
</body>
</html>
